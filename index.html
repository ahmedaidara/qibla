<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direction de la Qibla</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .compass {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            position: relative;
            background: #f5f5f5;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            margin: 0 auto;
            transition: transform 0.5s ease;
        }
        
        .compass-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .compass-arrow {
            width: 40px;
            height: 40px;
            background-color: #e53e3e;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .compass-markers {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .compass-marker {
            position: absolute;
            width: 2px;
            height: 15px;
            background: #333;
            left: 50%;
            transform-origin: bottom center;
        }
        
        .compass-cardinal {
            position: absolute;
            font-weight: bold;
            color: #333;
        }
        
        .qibla-indicator {
            position: absolute;
            width: 4px;
            height: 100px;
            background-color: #38a169;
            left: 50%;
            bottom: 50%;
            transform-origin: bottom center;
            z-index: 5;
        }
        
        .qibla-label {
            position: absolute;
            color: #38a169;
            font-weight: bold;
            transform: translate(-50%, -120%);
            white-space: nowrap;
        }
        
        @media (max-width: 640px) {
            .compass {
                width: 250px;
                height: 250px;
            }
            
            .qibla-indicator {
                height: 80px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-xl shadow-lg overflow-hidden p-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Direction de la Qibla</h1>
            <p class="text-gray-600">Orientez-vous vers la Kaaba à La Mecque</p>
        </div>
        
        <div class="compass mb-6">
            <div class="compass-inner">
                <div class="compass-arrow"></div>
                <div class="compass-markers" id="compass-markers"></div>
                <div class="qibla-indicator" id="qibla-indicator">
                    <span class="qibla-label">Qibla</span>
                </div>
            </div>
        </div>
        
        <div class="bg-blue-50 rounded-lg p-4 mb-6">
            <div class="flex items-center mb-2">
                <i class="fas fa-location-arrow text-blue-500 mr-2"></i>
                <span class="font-semibold">Votre position:</span>
                <span id="location" class="ml-2 text-gray-700">Détection en cours...</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-compass text-green-600 mr-2"></i>
                <span class="font-semibold">Direction Qibla:</span>
                <span id="qibla-direction" class="ml-2 text-gray-700">Calcul...</span>
            </div>
        </div>
        
        <div class="flex justify-center">
            <button id="reload-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                <i class="fas fa-sync-alt mr-2"></i> Actualiser
            </button>
        </div>
    </div>
    
    <div class="mt-6 text-center text-gray-500 text-sm">
        <p>Cette application utilise la géolocalisation de votre appareil pour calculer la direction de la Qibla.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const compass = document.querySelector('.compass');
            const qiblaIndicator = document.getElementById('qibla-indicator');
            const locationDisplay = document.getElementById('location');
            const qiblaDirectionDisplay = document.getElementById('qibla-direction');
            const reloadBtn = document.getElementById('reload-btn');
            const compassMarkers = document.getElementById('compass-markers');
            
            // Create compass markers
            for (let i = 0; i < 360; i += 15) {
                const marker = document.createElement('div');
                marker.className = 'compass-marker';
                marker.style.transform = `rotate(${i}deg)`;
                
                if (i % 90 === 0) {
                    const cardinal = document.createElement('div');
                    cardinal.className = 'compass-cardinal';
                    let direction;
                    
                    if (i === 0) direction = 'N';
                    else if (i === 90) direction = 'E';
                    else if (i === 180) direction = 'S';
                    else if (i === 270) direction = 'O';
                    
                    cardinal.textContent = direction;
                    cardinal.style.transform = `rotate(${-i}deg)`;
                    
                    // Position the cardinal points
                    const angleRad = (i * Math.PI) / 180;
                    const radius = 120;
                    const x = radius * Math.sin(angleRad);
                    const y = -radius * Math.cos(angleRad);
                    
                    cardinal.style.left = `calc(50% + ${x}px)`;
                    cardinal.style.top = `calc(50% + ${y}px)`;
                    
                    marker.style.height = '25px';
                    marker.style.backgroundColor = '#e53e3e';
                    
                    compassMarkers.appendChild(cardinal);
                }
                
                compassMarkers.appendChild(marker);
            }
            
            let currentPosition = null;
            let currentHeading = null;
            
            // Calculate Qibla direction
            function calculateQiblaDirection(lat, lng) {
                // Kaaba coordinates
                const kaabaLat = 21.3891;
                const kaabaLng = 39.8579;
                
                // Convert degrees to radians
                const latRad = lat * Math.PI / 180;
                const lngRad = lng * Math.PI / 180;
                const kaabaLatRad = kaabaLat * Math.PI / 180;
                const kaabaLngRad = kaabaLng * Math.PI / 180;
                
                // Calculate the bearing
                const y = Math.sin(kaabaLngRad - lngRad) * Math.cos(kaabaLatRad);
                const x = Math.cos(latRad) * Math.sin(kaabaLatRad) - 
                          Math.sin(latRad) * Math.cos(kaabaLatRad) * Math.cos(kaabaLngRad - lngRad);
                let bearing = Math.atan2(y, x) * 180 / Math.PI;
                bearing = (bearing + 360) % 360;
                
                return bearing;
            }
            
            // Update compass display
            function updateCompass() {
                if (currentPosition && currentHeading !== null) {
                    const qiblaDirection = calculateQiblaDirection(
                        currentPosition.coords.latitude, 
                        currentPosition.coords.longitude
                    );
                    
                    // Adjust for device orientation
                    const adjustedDirection = (360 - currentHeading + qiblaDirection) % 360;
                    
                    // Rotate the compass
                    compass.style.transform = `rotate(${currentHeading}deg)`;
                    
                    // Position the Qibla indicator
                    qiblaIndicator.style.transform = `rotate(${adjustedDirection}deg)`;
                    
                    // Update text displays
                    locationDisplay.textContent = 
                        `${currentPosition.coords.latitude.toFixed(4)}, ${currentPosition.coords.longitude.toFixed(4)}`;
                    
                    qiblaDirectionDisplay.textContent = `${Math.round(qiblaDirection)}° ${getCardinalDirection(qiblaDirection)}`;
                }
            }
            
            // Get cardinal direction from degrees
            function getCardinalDirection(angle) {
                const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
                return directions[Math.round(angle / 45) % 8];
            }
            
            // Handle device orientation
            function handleOrientation(event) {
                if (event.absolute && event.alpha !== null) {
                    currentHeading = event.alpha;
                    updateCompass();
                }
            }
            
            // Get current position
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            currentPosition = position;
                            updateCompass();
                        },
                        function(error) {
                            console.error("Erreur de géolocalisation:", error);
                            locationDisplay.textContent = "Erreur de géolocalisation";
                        },
                        { enableHighAccuracy: true }
                    );
                } else {
                    locationDisplay.textContent = "Géolocalisation non supportée";
                }
            }
            
            // Initialize
            getLocation();
            
            // Add event listeners
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                console.log("L'orientation de l'appareil n'est pas supportée");
            }
            
            reloadBtn.addEventListener('click', function() {
                getLocation();
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            });
            
            // Check for permission on iOS 13+
            function checkPermission() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                            }
                        })
                        .catch(console.error);
                }
            }
            
            // For iOS, we need to request permission on user gesture
            reloadBtn.addEventListener('click', checkPermission);
        });
    </script>
</body>
</html>
